<html>
    <head>
        <title>Book manager | Top page</title>
    </head>
    <body onload="getBookList();">
        <header></header>
        <div id="main-contents">
            <h1 id="title">Top page</h1>
            <div id="book">
                <div id="book-list-contents">
                    <table id="book-list">
                    </table>
                </div>
                <div id="list-controler">
                    <button id="list-down" onclick="listUp(0);">Page Down</button>
                    <span id="list-number">1</span>
                    <button id="list-up" onclick="listUp(1);">Page Up</button>
                </div>
            </div>
        </div>
        <footer></footer>
    </body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let number_of_book = 10;
        socket.on('book-list', (information) => {
            viewBookList(information);
        });

        function getBookList() {
            let list_number = document.getElementById('list-number').innerHTML;
            let data = {head: (list_number - 1) * number_of_book + 1, number_of_data: number_of_book};
            socket.emit('book-list', data);
        }

        function listUp(flag) {
            let list_number = document.getElementById('list-number').innerHTML;
            if (flag == 0 && list_number != 1) {
                document.getElementById('list-number').innerHTML = list_number - 1;
            } else if (flag == 1) {
                document.getElementById('list-number').innerHTML = +list_number + 1;
            }
            getBookList();
        }

        async function viewBookList(information) {
            if (0 < information.book_list.length) {
                let reqURL = 'https://api.openbd.jp/v1/get?isbn=';
                let inner_html = '<tr id="book-list-header"><th>ISBN</th><th>Title</th><th>Author(s)</th><th>Publisher</th><th>Publication Date</th><th>Number of Pages</th><th>Review</th></tr>';
                for (let i = 0; i < information.book_list.length; i++) {
                    inner_html += await getBookJson(reqURL + information.book_list[i].isbn, information.book_list[i]);
                }
                document.getElementById('book-list').innerHTML = inner_html;
            } else {
                listUp(0);
            }
        }

        async function getBookJson(reqURL, book_list) {
            const res = await fetch(reqURL);
            const json = (await res.json())[0];
            let inner_html = '';
            inner_html += '<tr id="book-list-data">';
            inner_html += '<td>' + json.summary.isbn + '</td>';
            inner_html += '<td>' + json.summary.title + '</td>';
            inner_html += '<td>' + json.summary.author + '</td>';
            inner_html += '<td>' + json.summary.publisher + '</td>';
            inner_html += '<td>' + json.summary.pubdate + '</td>';
            inner_html += '<td>' + json.summary.volume + '</td>';
            if (book_list.dokuryo) {
                inner_html += '<td><button class="show-review-btn" onclick="showReview();">Show reviews</button></td>';
            }
            inner_html += '</tr>';
            return inner_html;
        }
    </script>
</html>